# Here, we wanted to visualize the metabolic patterns observed in the data set
# We generated boxplots for each of the metabolites and we performed an enrichment pathway analysis

--------------- Box plots --------------

# I) we generated in R a PDF file with a box plot for each of the metabolites (We used (D1) summarized experiments)

rownames(D1)=paste(rownames(D1),"Metabolite")
rownames(D1)=make.names(rownames(D1))
try(dev.off(),silent = TRUE)
pdf("boxplot_metabolites.pdf",height=10,width=7)
par(mfrow=c(4,3))
ix=sort(rowData(D1)$name,index.return=TRUE)$ix
k=-1
for (i in ix){
  k=k+1
  l=k%%3
  lmet=rowData(D1)$name[i]
  cat("working on", i,lmet,"\n")
  pdata=assay(D1)[i,]
  if(grepl("Metabolite",lmet)&(l!=0)){
    plot(c(0,1),c(1,1))
    k=k+1
    l=k%%3
  } 
  if(grepl("Metabolite",lmet)&(l!=0)){
    plot(c(0,1),c(1,1))
    k=k+1
    l=k%%3
  } 
  
  xdata=D1$Diagnosis
  boxplot(pdata~xdata,notch=TRUE,xlab="Group",ylab="log ion count",main=lmet)
}

dev.off()

--------------- Pathway enrichment -------------

# J) Using the pairwise comparison results (D2_Metabolites_Analysis_2.xlsx), we performed pathway enrichment of (control(ctr) vs CD, control(ctr) vs UC, and UC vs CD) and generate a PDF file for each enrichment

# control(ctr) vs CD

library(readxl)

ctr_cd_stat= read_excel(path = "D2_Metabolites_Analysis_2.xlsx",sheet="ctr_CD")
boxplot(ctr_cd_stat$statistic~ctr_cd_stat$feat_col, xlab = "pathway",
        ylab = "stat", main = "Chemical Pathway")

try(dev.off(),silent = TRUE)
pdf("Metabolic_enrichments_CD.pdf",height=100,width=10)
stat= ctr_cd_stat$statistic
feature= ctr_cd_stat$feat_col
x=table(feature)
ix=which(x>10)
x2=x[ix]
names(x2)
statmean=rep(NA,length(x2))
k=0
for (f in names(x2)){
  k=k+1
  cat("working on",f,"\n")
  ix=which(feature==f)
  stat[ix]
  mean(stat[ix])
  statmean[k]= mean(stat[ix])
}
s=sort(statmean,index.return=TRUE)
names(x2)[s$ix]
feature2=c()
stat2=c()
for (f in names(x2)[s$ix]){
  cat("working on",f,"\n")
  ix=which(feature==f)
  stat2=c(stat2,stat[ix])
  feature2=c(feature2,rep(f,length(ix)))
}
feature3=factor(feature2,levels=unique(feature2))
boxplot(stat2~feature3,horizontal=TRUE)

dev.off()

# control(ctr) vs UC

ctr_cd_stat= read_excel(path = "D2_Metabolites_Analysis_2.xlsx",sheet="ctr_UC")
boxplot(ctr_cd_stat$statistic~ctr_cd_stat$feat_col, xlab = "pathway",
        ylab = "stat", main = "Chemical Pathway")

try(dev.off(),silent = TRUE)
pdf("Metabolic_enrichments_UC.pdf",height=100,width=10)
stat= ctr_cd_stat$statistic
feature= ctr_cd_stat$feat_col
x=table(feature)
ix=which(x>10)
x2=x[ix]
names(x2)
statmean=rep(NA,length(x2))
k=0
for (f in names(x2)){
  k=k+1
  cat("working on",f,"\n")
  ix=which(feature==f)
  stat[ix]
  mean(stat[ix])
  statmean[k]= mean(stat[ix])
}
s=sort(statmean,index.return=TRUE)
names(x2)[s$ix]
feature2=c()
stat2=c()
for (f in names(x2)[s$ix]){
  cat("working on",f,"\n")
  ix=which(feature==f)
  stat2=c(stat2,stat[ix])
  feature2=c(feature2,rep(f,length(ix)))
}
feature3=factor(feature2,levels=unique(feature2))
boxplot(stat2~feature3,horizontal=TRUE,main="UC")

dev.off()

# CD vs UC

ctr_cd_stat= read_excel(path = "D2_Metabolites_Analysis_2.xlsx",sheet="UC_CD")
boxplot(ctr_cd_stat$statistic~ctr_cd_stat$feat_col, xlab = "pathway",
        ylab = "stat", main = "Chemical Pathway")

try(dev.off(),silent = TRUE)
pdf("Metabolic_enrichments_UC_CD.pdf",height=100,width=10)
stat= ctr_cd_stat$statistic
feature= ctr_cd_stat$feat_col
x=table(feature)
ix=which(x>10)
x2=x[ix]
names(x2)
statmean=rep(NA,length(x2))
k=0
for (f in names(x2)){
  k=k+1
  cat("working on",f,"\n")
  ix=which(feature==f)
  stat[ix]
  mean(stat[ix])
  statmean[k]= mean(stat[ix])
}
s=sort(statmean,index.return=TRUE)
names(x2)[s$ix]
feature2=c()
stat2=c()
for (f in names(x2)[s$ix]){
  cat("working on",f,"\n")
  ix=which(feature==f)
  stat2=c(stat2,stat[ix])
  feature2=c(feature2,rep(f,length(ix)))
}
feature3=factor(feature2,levels=unique(feature2))
boxplot(stat2~feature3,horizontal=TRUE,main="UC_CD")

dev.off()

--------------- To view the PDF files: Kindly see results folder --------------
